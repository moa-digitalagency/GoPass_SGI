<!--
* Nom de l'application : GoPass SGI-GP
 * Description : Logic and implementation for pos.html
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
-->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('pos.title') }} - {{ t('global.app_name') }}</title>
    <!-- Tailwind CSS (Local or CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Scrollbar for list areas */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #E5E7EB;
            border-radius: 20px;
        }

        .step-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-[#F3F4F6] text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- 1. HEADER -->
    <header class="bg-white border-b border-gray-200 h-16 flex justify-between items-center px-6 shadow-sm z-10 flex-shrink-0">
        <!-- Left: Logo -->
        <div class="flex items-center space-x-3">
             <img id="pos-logo-rva" src="" class="h-8 w-auto hidden">
             <div class="flex items-center text-blue-800 font-bold text-xl tracking-tight">
                <i class="fas fa-plane-departure mr-2"></i>
                <span>SGI-GP <span class="text-blue-600 font-normal">Agent</span></span>
             </div>
        </div>

        <!-- Center: Badge -->
        <div class="bg-blue-50 text-blue-700 px-4 py-1.5 rounded-full text-sm font-semibold border border-blue-100 shadow-sm">
            <i class="fas fa-desktop mr-2 text-blue-500"></i> Guichet N° {{ current_user.id }}
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center space-x-6">
            <!-- Total Caisse -->
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Total Session</span>
                <span class="text-green-600 font-bold text-lg leading-none" id="totalSalesDisplay">{{ total_sales|default(0.0) }} $</span>
            </div>

            <!-- Divider -->
            <div class="h-8 w-px bg-gray-200"></div>

            <!-- User & Logout -->
            <div class="flex items-center space-x-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-gray-700">{{ current_user.first_name }}</p>
                    <p class="text-xs text-gray-400">{{ current_user.location }}</p>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="group bg-red-50 hover:bg-red-100 p-2 rounded-lg text-red-500 transition-colors" title="Déconnexion">
                    <i class="fas fa-power-off text-lg group-hover:scale-110 transition-transform"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT (Split Screen) -->
    <main class="flex-1 flex flex-col lg:flex-row p-4 lg:p-6 gap-6 overflow-y-auto lg:overflow-hidden">

        <!-- 2. GAUCHE : FORMULAIRE (65%) -->
        <section class="w-full lg:w-[65%] flex flex-col lg:h-full flex-shrink-0">
            <div class="bg-white rounded-2xl shadow-lg flex-col lg:flex-1 overflow-hidden relative h-auto min-h-[500px] lg:h-auto flex">

                <!-- Card Header -->
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-ticket-alt"></i>
                        </span>
                        Émission de Titre de Voyage
                    </h2>

                    <!-- Steps Indicator -->
                    <div class="flex items-center space-x-2 text-sm">
                        <span id="badge-step-1" class="px-3 py-1 rounded-full bg-blue-600 text-white font-bold">1. Vol</span>
                        <div class="w-4 h-0.5 bg-gray-300"></div>
                        <span id="badge-step-2" class="px-3 py-1 rounded-full bg-gray-200 text-gray-500 font-bold">2. Passagers</span>
                    </div>
                </div>

                <!-- Scrollable Form Area -->
                <div class="p-8 lg:overflow-y-auto flex-1 custom-scrollbar relative">
                    <form id="posForm" class="space-y-8 max-w-3xl mx-auto">

                        <!-- ================= PHASE 1: SÉLECTION VOL ================= -->
                        <div id="phase-flight">

                            <!-- Mode Switcher -->
                            <div class="bg-gray-100 p-1.5 rounded-xl flex shadow-inner mb-6">
                                <button type="button" onclick="setFlightMode('today')" id="btn-mode-today" class="flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600">
                                    <i class="fas fa-calendar-day mr-2"></i> Vols du Jour
                                </button>
                                <button type="button" onclick="setFlightMode('manual')" id="btn-mode-manual" class="flex-1 py-2.5 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all">
                                    <i class="fas fa-calendar-plus mr-2"></i> Vol Ultérieur / Manuel
                                </button>
                            </div>
                            <input type="hidden" id="flight_mode" name="flight_mode" value="today">

                            <!-- Zone Vol : TODAY -->
                            <div id="zone-today" class="transition-all duration-300 space-y-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Sélectionner un vol</label>
                                <div class="relative">
                                    <select id="flight_id" name="flight_id" class="w-full pl-4 pr-10 py-4 border border-gray-200 rounded-xl appearance-none text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white shadow-sm transition-shadow hover:border-gray-300 text-lg">
                                        <option value="" disabled selected>-- Choisir dans la liste --</option>
                                        {% for flight in flights %}
                                        <option value="{{ flight.id }}" data-price="{{ 50.0 }}">
                                            {{ flight.departure_time.strftime('%H:%M') }} | {{ flight.airline }} {{ flight.flight_number }} | -> {{ flight.arrival_airport }}
                                        </option>
                                        {% else %}
                                        <option value="" disabled>Aucun vol prévu aujourd'hui</option>
                                        {% endfor %}
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <button type="button" onclick="confirmTodayFlight()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors shadow-md mt-4">
                                    <i class="fas fa-check mr-2"></i> Confirmer ce vol
                                </button>
                            </div>

                            <!-- Zone Vol : MANUAL -->
                            <div id="zone-manual" class="hidden transition-all duration-300 space-y-4">
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date de Départ</label>
                                        <input type="date" id="manual_flight_date" name="manual_flight_date" class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm" onchange="checkFlightInput()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Numéro de Vol</label>
                                        <div class="relative">
                                            <input type="text" id="manual_flight_number" name="manual_flight_number" placeholder="ex: AF123" class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm uppercase pr-12" oninput="checkFlightInput()">
                                            <div id="flight-spinner" class="absolute right-4 top-4 hidden">
                                                <i class="fas fa-circle-notch fa-spin text-blue-500"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bouton Vérifier -->
                                <div id="verify-btn-container" class="hidden">
                                    <button type="button" onclick="verifyManualFlight()" class="w-full bg-blue-100 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-200 transition-colors flex items-center justify-center">
                                        <i class="fas fa-search mr-2"></i> Vérifier le vol via AviationStack
                                    </button>
                                </div>

                                <!-- Fallback Error -->
                                <div id="flight-error-msg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl text-sm border border-red-100">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                        <span>Vol introuvable dans la base globale.</span>
                                    </div>
                                    <button type="button" onclick="enableManualOverride()" class="text-red-700 font-bold underline hover:text-red-800">
                                        Saisir manuellement
                                    </button>
                                </div>

                                <!-- Override Selector -->
                                <div id="manual-type-selector" class="hidden bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                    <label class="block text-sm font-semibold text-yellow-800 mb-2">Type de Vol (Saisie Forcée)</label>
                                    <select id="manual_flight_type" class="w-full p-3 border border-yellow-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-yellow-400" onchange="updatePriceManual()">
                                        <option value="international">International (55$)</option>
                                        <option value="national">Domestique (15$)</option>
                                    </select>
                                    <button type="button" onclick="confirmManualFlight(true)" class="w-full bg-yellow-500 text-white font-bold py-2 mt-3 rounded-lg hover:bg-yellow-600">
                                        Confirmer Saisie Manuelle
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ================= PHASE 1.5: CONFIRMED FLIGHT CARD ================= -->
                        <div id="confirmed-flight-card" class="hidden bg-white border-2 border-green-500 rounded-xl p-4 shadow-sm relative overflow-hidden">
                             <div class="absolute top-0 right-0 p-2">
                                <span id="cf-price-badge" class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded">INTERNATIONAL</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-plane"></i>
                                </div>
                                <div>
                                    <h4 id="cf-airline" class="font-bold text-gray-800">Air France</h4>
                                    <p class="text-sm text-gray-500">
                                        <span id="cf-route">FIH ➔ CDG</span> | <span id="cf-date">2023-10-27</span>
                                    </p>
                                </div>
                            </div>
                            <button type="button" onclick="resetFlightSelection()" class="absolute bottom-2 right-2 text-xs text-gray-400 hover:text-red-500 underline">
                                Changer de vol
                            </button>
                        </div>


                        <!-- ================= PHASE 2: PASSENGERS ================= -->
                        <div id="phase-passengers" class="hidden space-y-6">

                            <!-- Passenger List -->
                            <div id="passenger-list" class="space-y-3">
                                <!-- Items will be added here -->
                            </div>

                            <!-- Add Passenger Form -->
                            <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                                <h3 class="text-sm font-bold text-blue-800 mb-4"><i class="fas fa-user-plus mr-2"></i>Ajouter un passager</h3>

                                <div class="space-y-4">
                                    <div>
                                        <input type="text" id="new_p_name" class="w-full p-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 bg-white" placeholder="Nom Complet (ex: Jean Dupont)" autocomplete="off">
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="col-span-1">
                                            <select id="new_p_type" class="w-full p-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 bg-white">
                                                <option value="Passeport">Passeport</option>
                                                <option value="Carte d'Identité">Carte ID</option>
                                                <option value="Permis de Conduire">Permis</option>
                                            </select>
                                        </div>
                                        <div class="col-span-2">
                                            <input type="text" id="new_p_doc" class="w-full p-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 bg-white" placeholder="N° Document">
                                        </div>
                                    </div>
                                    <button type="button" onclick="addPassenger()" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                                        Ajouter à la liste
                                    </button>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>

                <!-- Composant C : Footer Validation -->
                <div class="p-6 bg-gray-50 border-t border-gray-200 z-10">
                    <div class="max-w-3xl mx-auto flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Montant à percevoir (<span id="count-passengers">0</span> passagers)</p>
                            <p class="text-3xl font-bold text-gray-800" id="display-amount">0.00 $</p>
                        </div>
                        <button type="button" onclick="submitSale()" id="submitBtn" class="bg-gray-300 text-gray-500 cursor-not-allowed font-bold py-4 px-10 rounded-2xl shadow-none flex items-center text-lg transition-all" disabled>
                            <i class="fas fa-print mr-3"></i>
                            <span>ENCAISSER & IMPRIMER</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. DROITE : HISTORIQUE (35%) -->
        <section class="w-full lg:w-[35%] flex flex-col lg:h-full flex-shrink-0 mt-6 lg:mt-0 pb-6 lg:pb-0">
            <div class="bg-white rounded-2xl shadow-lg flex flex-col h-[400px] lg:h-full overflow-hidden border border-gray-100">
                <div class="p-5 border-b border-gray-100 bg-gray-50/80 backdrop-blur">
                    <h3 class="font-bold text-gray-800 flex items-center">
                        <i class="fas fa-history mr-2 text-blue-500"></i> Ventes Récentes
                    </h3>
                </div>

                <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-gray-50/30">
                    <!-- Empty State -->
                    <div id="empty-state" class="flex flex-col items-center justify-center h-48 text-gray-400">
                        <i class="fas fa-receipt text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">Aucune vente cette session</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Hidden iframe container for printing loop -->
    <div id="print-container" style="display:none;"></div>

    <script>
        // --- STATE MANAGEMENT ---
        const appState = {
            step: 0, // 0: Flight, 1: Passengers
            flightMode: 'today',
            flightData: null, // {id, number, airline, date, ...}
            passengers: [],
            unitPrice: 50.0,
            verificationSource: 'manual',
            flightDetails: null // Full JSON from API if available
        };

        // --- DOM ELEMENTS ---
        const els = {
            phaseFlight: document.getElementById('phase-flight'),
            phasePassengers: document.getElementById('phase-passengers'),
            zoneToday: document.getElementById('zone-today'),
            zoneManual: document.getElementById('zone-manual'),
            badge1: document.getElementById('badge-step-1'),
            badge2: document.getElementById('badge-step-2'),
            confirmedCard: document.getElementById('confirmed-flight-card'),
            submitBtn: document.getElementById('submitBtn'),
            displayAmount: document.getElementById('display-amount'),
            countPassengers: document.getElementById('count-passengers'),
            passengerList: document.getElementById('passenger-list'),
            inputs: {
                new_name: document.getElementById('new_p_name'),
                new_doc: document.getElementById('new_p_doc'),
                new_type: document.getElementById('new_p_type')
            }
        };

        // --- PHASE 1: FLIGHT LOGIC ---

        function setFlightMode(mode) {
            appState.flightMode = mode;
            document.getElementById('flight_mode').value = mode;

            const btnToday = document.getElementById('btn-mode-today');
            const btnManual = document.getElementById('btn-mode-manual');

            if (mode === 'today') {
                btnToday.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600";
                btnManual.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all";
                els.zoneToday.classList.remove('hidden');
                els.zoneManual.classList.add('hidden');
                appState.unitPrice = 50.0;
            } else {
                btnToday.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all";
                btnManual.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600";
                els.zoneToday.classList.add('hidden');
                els.zoneManual.classList.remove('hidden');
                appState.unitPrice = 55.0; // Default Int
            }
            updateTotals();
        }

        function confirmTodayFlight() {
            const select = document.getElementById('flight_id');
            const val = select.value;
            if (!val) {
                alert("Veuillez sélectionner un vol.");
                return;
            }

            const opt = select.options[select.selectedIndex];
            const text = opt.text;
            // Parse simplistic text "HH:MM | Airline No | -> Dest"
            // Or just use text for display.

            appState.flightData = {
                id: val,
                desc: text,
                mode: 'today'
            };
            const price = parseFloat(opt.dataset.price || "50.0");
            appState.unitPrice = price;
            appState.verificationSource = 'manual'; // It's from DB list, so trusted but manual selection
            appState.flightDetails = null;

            lockFlightPhase();
        }

        function checkFlightInput() {
            const num = document.getElementById('manual_flight_number').value;
            const date = document.getElementById('manual_flight_date').value;
            const btn = document.getElementById('verify-btn-container');

            if (num.length >= 3 && date) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        async function verifyManualFlight() {
            const num = document.getElementById('manual_flight_number').value;
            const date = document.getElementById('manual_flight_date').value;
            const spinner = document.getElementById('flight-spinner');

            spinner.classList.remove('hidden');

            try {
                 const response = await fetch("{{ url_for('api.verify_flight') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
                    body: JSON.stringify({ flight_number: num, flight_date: date })
                });

                const data = await response.json();

                if (response.ok && data.found) {
                    appState.flightData = {
                        number: data.flight_data.airline + ' ' + num.toUpperCase(),
                        date: date,
                        route: `${data.flight_data.departure.iata} ➔ ${data.flight_data.arrival.iata}`,
                        airline: data.flight_data.airline,
                        mode: 'manual'
                    };
                    appState.unitPrice = data.pricing.amount;
                    appState.verificationSource = 'api';
                    appState.flightDetails = data.flight_data;

                    // Directly confirm if found
                    lockFlightPhase();

                } else {
                     document.getElementById('flight-error-msg').classList.remove('hidden');
                }

            } catch(e) {
                alert("Erreur de connexion");
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function enableManualOverride() {
            document.getElementById('flight-error-msg').classList.add('hidden');
            document.getElementById('manual-type-selector').classList.remove('hidden');
            updatePriceManual();
        }

        function updatePriceManual() {
            const type = document.getElementById('manual_flight_type').value;
            appState.unitPrice = (type === 'national') ? 15.0 : 55.0;
        }

        function confirmManualFlight(force = false) {
             const num = document.getElementById('manual_flight_number').value;
             const date = document.getElementById('manual_flight_date').value;

             if (!num || !date) return;

             if (force) {
                 appState.flightData = {
                     number: num.toUpperCase(),
                     date: date,
                     route: "Vol Manuel",
                     airline: "Inconnu",
                     mode: 'manual'
                 };
                 appState.verificationSource = 'manual';
                 appState.flightDetails = null;
                 // Price already set by updatePriceManual
             }

             lockFlightPhase();
        }

        function lockFlightPhase() {
            appState.step = 1;

            // Hide Selector
            els.phaseFlight.classList.add('hidden');

            // Show Card
            els.confirmedCard.classList.remove('hidden');

            // Fill Card
            if (appState.flightMode === 'today') {
                document.getElementById('cf-airline').textContent = "Vol du Jour";
                document.getElementById('cf-route').textContent = appState.flightData.desc;
                document.getElementById('cf-date').textContent = new Date().toISOString().split('T')[0];
            } else {
                document.getElementById('cf-airline').textContent = appState.flightData.airline;
                document.getElementById('cf-route').textContent = appState.flightData.route || (appState.flightData.number);
                document.getElementById('cf-date').textContent = appState.flightData.date;
            }

            document.getElementById('cf-price-badge').textContent = (appState.unitPrice < 50) ? 'DOMESTIQUE' : 'INTERNATIONAL';
            document.getElementById('cf-price-badge').className = (appState.unitPrice < 50)
                ? "bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded"
                : "bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded";

            // Update Steps
            els.badge1.classList.replace('bg-blue-600', 'bg-green-500');
            els.badge1.innerHTML = '<i class="fas fa-check mr-1"></i> Vol OK';
            els.badge2.classList.replace('bg-gray-200', 'bg-blue-600');
            els.badge2.classList.replace('text-gray-500', 'text-white');

            // Show Passengers
            els.phasePassengers.classList.remove('hidden');

            // Focus
            setTimeout(() => els.inputs.new_name.focus(), 100);

            checkValidation();
        }

        function resetFlightSelection() {
            if (!confirm("Attention : Cela va réinitialiser la liste des passagers. Continuer ?")) return;

            appState.step = 0;
            appState.passengers = [];
            appState.flightData = null;

            els.phaseFlight.classList.remove('hidden');
            els.confirmedCard.classList.add('hidden');
            els.phasePassengers.classList.add('hidden');

            // Reset Badges
            els.badge1.classList.replace('bg-green-500', 'bg-blue-600');
            els.badge1.innerHTML = '1. Vol';
            els.badge2.classList.replace('bg-blue-600', 'bg-gray-200');
            els.badge2.classList.replace('text-white', 'text-gray-500');

            renderPassengers();
            checkValidation();
        }

        // --- PHASE 2: PASSENGER LOGIC ---

        function addPassenger() {
            const name = els.inputs.new_name.value.trim();
            const doc = els.inputs.new_doc.value.trim();
            const type = els.inputs.new_type.value;

            if (!name || !doc) {
                alert("Nom et Numéro de document requis.");
                return;
            }

            appState.passengers.push({ name, doc_num: doc, doc_type: type });

            // Clear inputs
            els.inputs.new_name.value = '';
            els.inputs.new_doc.value = '';
            els.inputs.new_name.focus();

            renderPassengers();
            checkValidation();
        }

        function removePassenger(index) {
            appState.passengers.splice(index, 1);
            renderPassengers();
            checkValidation();
        }

        function renderPassengers() {
            els.passengerList.innerHTML = '';
            appState.passengers.forEach((p, idx) => {
                const el = document.createElement('div');
                el.className = "flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200 shadow-sm";
                el.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center text-gray-500 text-sm font-bold">
                            ${idx + 1}
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">${p.name}</p>
                            <p class="text-xs text-gray-500">${p.doc_type}: ${p.doc_num}</p>
                        </div>
                    </div>
                    <button onclick="removePassenger(${idx})" class="text-red-400 hover:text-red-600 p-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                els.passengerList.appendChild(el);
            });

            updateTotals();
        }

        function updateTotals() {
            const count = appState.passengers.length;
            const total = count * appState.unitPrice;

            els.countPassengers.textContent = count;
            els.displayAmount.textContent = total.toFixed(2) + " $";
        }

        // --- PHASE 3: VALIDATION & SUBMIT ---

        function checkValidation() {
            const isValid = appState.step === 1 && appState.passengers.length > 0;

            if (isValid) {
                els.submitBtn.disabled = false;
                els.submitBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                els.submitBtn.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-teal-600', 'text-white', 'shadow-lg', 'hover:from-emerald-600');
            } else {
                els.submitBtn.disabled = true;
                els.submitBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                els.submitBtn.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-teal-600', 'text-white', 'shadow-lg', 'hover:from-emerald-600');
            }
        }

        async function submitSale() {
            if (els.submitBtn.disabled) return;

            const originalHtml = els.submitBtn.innerHTML;
            els.submitBtn.disabled = true;
            els.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> TRAITEMENT...';

            // Payload Construction
            const payload = {
                flight_mode: appState.flightMode,
                flight_id: (appState.flightMode === 'today') ? appState.flightData.id : null,
                manual_flight_number: (appState.flightMode === 'manual') ? document.getElementById('manual_flight_number').value : null,
                manual_flight_date: (appState.flightMode === 'manual') ? document.getElementById('manual_flight_date').value : null,

                passengers: appState.passengers,
                price: appState.unitPrice,
                verification_source: appState.verificationSource,
                flight_details: appState.flightDetails
            };

            try {
                const response = await fetch("{{ url_for('ops.pos_sale') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast(`${result.tickets.length} billets générés !`);

                    // Add to history
                    addToHistory(result);

                    // Update Session Total
                    let currentTotal = parseFloat(document.getElementById('totalSalesDisplay').textContent);
                    currentTotal += result.total_price;
                    document.getElementById('totalSalesDisplay').textContent = currentTotal.toFixed(1) + " $";

                    // PRINT LOOP
                    await printLoop(result.tickets);

                    // Reset Logic
                    resetAfterSale();

                } else {
                    alert("Erreur: " + (result.error || "Inconnue"));
                }

            } catch(e) {
                alert("Erreur réseau: " + e.message);
                console.error(e);
            } finally {
                els.submitBtn.disabled = false;
                els.submitBtn.innerHTML = originalHtml;
                checkValidation(); // Will disable it because list cleared
            }
        }

        function resetAfterSale() {
            // Keep flight locked (Operator might process next family for same flight)
            // Just clear passengers
            appState.passengers = [];
            renderPassengers();
            checkValidation(); // disables button
        }

        // --- PRINTING ---
        async function printLoop(tickets) {
            const container = document.getElementById('print-container');
            container.innerHTML = '';

            for (const ticket of tickets) {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = ticket.pdf_url;
                container.appendChild(iframe);

                // Wait for load and print
                await new Promise((resolve) => {
                    iframe.onload = () => {
                         setTimeout(() => {
                             iframe.contentWindow.focus();
                             iframe.contentWindow.print();
                             resolve();
                         }, 1000); // 1s delay between prints
                    };
                });
            }
        }

        // --- HISTORY ---
        function addToHistory(data) {
             const list = document.getElementById('history-list');
             const empty = document.getElementById('empty-state');
             if (empty) empty.remove();

             // For bulk sale, maybe group them? Or list individual?
             // Prompt says "1 Ticket Thermique par passager".
             // History usually shows transactions.
             // We'll show one entry per passenger to be consistent with old view, or a group entry.
             // Let's show a group entry "Famille (3p)" or similar.
             // But existing design shows individual. Let's stick to individual for audit clarity in UI.

             data.tickets.forEach(ticket => {
                 const item = document.createElement('div');
                 item.className = "bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center animate-fade-in-down mb-2";
                 item.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-xs font-bold text-gray-400">${data.time}</span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">${data.flight_number}</span>
                        </div>
                        <p class="font-bold text-gray-800 text-sm truncate max-w-[150px]">${ticket.passenger_name}</p>
                        <p class="text-xs text-green-600 font-semibold mt-1">
                            <i class="fas fa-check-circle mr-1"></i> Payé ${ticket.price} $
                        </p>
                    </div>
                    <button onclick="reprintOne('${ticket.pdf_url}')" class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-500 transition-colors" title="Réimprimer">
                        <i class="fas fa-print"></i>
                    </button>
                 `;
                 list.insertBefore(item, list.firstChild);
             });
        }

        function reprintOne(url) {
             const container = document.getElementById('print-container');
             container.innerHTML = '';
             const iframe = document.createElement('iframe');
             iframe.style.display = 'none';
             iframe.src = url;
             container.appendChild(iframe);
             iframe.onload = function() {
                setTimeout(function() {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                }, 500);
            };
        }

        // Simple Toast
        function showToast(message) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = "fixed bottom-6 right-6 z-50 flex flex-col space-y-2";
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = "bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center transform transition-all duration-300 translate-y-10 opacity-0";
            toast.innerHTML = `<i class="fas fa-check-circle text-green-400 mr-3"></i> ${message}`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Branding Load
        document.addEventListener('DOMContentLoaded', () => {
             fetch('/api/settings/public')
                .then(r => r.json())
                .then(data => {
                    if (data.rva_logo) {
                        const img = document.getElementById('pos-logo-rva');
                        img.src = data.rva_logo;
                        img.classList.remove('hidden');
                    }
                })
                .catch(console.error);
        });

    </script>
    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
    </style>
</body>
</html>
