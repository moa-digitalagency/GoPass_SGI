<!--
* Nom de l'application : GoPass SGI-GP
 * Description : Logic and implementation for pos.html
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
-->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('pos.title') }} - {{ t('global.app_name') }}</title>
    <!-- Tailwind CSS (Local or CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ops/pos.css') }}">
</head>
<body class="bg-[#F3F4F6] text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- 1. HEADER -->
    <header class="bg-white border-b border-gray-200 h-16 flex justify-between items-center px-6 shadow-sm z-10 flex-shrink-0">
        <!-- Left: Logo -->
        <div class="flex items-center space-x-3">
             <img id="pos-logo-rva" src="" class="h-8 w-auto hidden">
             <div class="flex items-center text-blue-800 font-bold text-xl tracking-tight">
                <i class="fas fa-plane-departure mr-2"></i>
                <span>SGI-GP <span class="text-blue-600 font-normal">Agent</span></span>
             </div>
        </div>

        <!-- Center: Badge -->
        <div class="bg-blue-50 text-blue-700 px-4 py-1.5 rounded-full text-sm font-semibold border border-blue-100 shadow-sm">
            <i class="fas fa-desktop mr-2 text-blue-500"></i> Guichet N° {{ current_user.id }}
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center space-x-6">
            <!-- Total Caisse -->
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Total Session</span>
                <span class="text-green-600 font-bold text-lg leading-none" id="totalSalesDisplay">{{ total_sales|default(0.0) }} $</span>
            </div>

            <!-- Divider -->
            <div class="h-8 w-px bg-gray-200"></div>

            <!-- User & Logout -->
            <div class="flex items-center space-x-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-gray-700">{{ current_user.first_name }}</p>
                    <p class="text-xs text-gray-400">{{ current_user.location }}</p>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="group bg-red-50 hover:bg-red-100 p-2 rounded-lg text-red-500 transition-colors" title="Déconnexion">
                    <i class="fas fa-power-off text-lg group-hover:scale-110 transition-transform"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT (Split Screen) -->
    <main class="flex-1 flex flex-col lg:flex-row p-4 lg:p-6 gap-6 overflow-y-auto lg:overflow-hidden relative">

        <!-- Mobile History FAB -->
        <button onclick="toggleHistory()" class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl z-40 flex items-center justify-center hover:bg-blue-700 transition-transform hover:scale-110">
            <i class="fas fa-history text-xl"></i>
            <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-white" id="mobile-history-badge">0</span>
        </button>

        <!-- 2. GAUCHE : FORMULAIRE (70%) -->
        <section class="w-full lg:w-[70%] flex flex-col lg:h-full flex-shrink-0 transition-all duration-300">
            <div class="bg-white rounded-2xl shadow-lg flex-col lg:flex-1 overflow-hidden relative h-auto min-h-[500px] lg:h-auto flex">

                <!-- Card Header -->
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-ticket-alt"></i>
                        </span>
                        Émission de Titre de Voyage
                    </h2>

                    <!-- Steps Indicator -->
                    <div class="flex items-center space-x-2 text-sm">
                        <span id="badge-step-1" class="px-3 py-1 rounded-full bg-blue-600 text-white font-bold">1. Vol</span>
                        <div class="w-4 h-0.5 bg-gray-300"></div>
                        <span id="badge-step-2" class="px-3 py-1 rounded-full bg-gray-200 text-gray-500 font-bold">2. Passagers</span>
                    </div>
                </div>

                <!-- Scrollable Form Area -->
                <div class="p-8 lg:overflow-y-auto flex-1 custom-scrollbar relative">
                    <form id="posForm" class="space-y-8 max-w-3xl mx-auto">

                        <!-- ================= PHASE 1: SÉLECTION VOL ================= -->
                        <div id="phase-flight">

                            <!-- Mode Switcher -->
                            <div class="bg-gray-100 p-1.5 rounded-xl flex shadow-inner mb-6">
                                <button type="button" onclick="setFlightMode('today')" id="btn-mode-today" class="flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600">
                                    <i class="fas fa-calendar-day mr-2"></i> Vols du Jour
                                </button>
                                <button type="button" onclick="setFlightMode('manual')" id="btn-mode-manual" class="flex-1 py-2.5 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all">
                                    <i class="fas fa-calendar-plus mr-2"></i> Vol Ultérieur / Manuel
                                </button>
                            </div>
                            <input type="hidden" id="flight_mode" name="flight_mode" value="today">

                            <!-- Zone Vol : TODAY -->
                            <div id="zone-today" class="transition-all duration-300 space-y-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Sélectionner un vol</label>
                                <div class="relative">
                                    <select id="flight_id" name="flight_id" class="w-full pl-4 pr-10 py-4 border border-gray-200 rounded-xl appearance-none text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white shadow-sm transition-shadow hover:border-gray-300 text-lg">
                                        <option value="" disabled selected>-- Choisir dans la liste --</option>
                                        {% for flight in flights %}
                                        <option value="{{ flight.id }}" data-price="{{ 50.0 }}">
                                            {{ flight.departure_time.strftime('%H:%M') }} | {{ flight.airline }} {{ flight.flight_number }} | -> {{ flight.arrival_airport }}
                                        </option>
                                        {% else %}
                                        <option value="" disabled>Aucun vol prévu aujourd'hui</option>
                                        {% endfor %}
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <button type="button" onclick="confirmTodayFlight()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors shadow-md mt-4">
                                    <i class="fas fa-check mr-2"></i> Confirmer ce vol
                                </button>
                            </div>

                            <!-- Zone Vol : MANUAL -->
                            <div id="zone-manual" class="hidden transition-all duration-300 space-y-4">
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date de Départ</label>
                                        <input type="date" id="manual_flight_date" name="manual_flight_date" class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm" onchange="checkFlightInput()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Numéro de Vol</label>
                                        <div class="relative">
                                            <input type="text" id="manual_flight_number" name="manual_flight_number" placeholder="ex: AF123" class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm uppercase pr-12" oninput="checkFlightInput()">
                                            <div id="flight-spinner" class="absolute right-4 top-4 hidden">
                                                <i class="fas fa-circle-notch fa-spin text-blue-500"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bouton Vérifier -->
                                <div id="verify-btn-container" class="hidden">
                                    <button type="button" onclick="verifyManualFlight()" class="w-full bg-blue-100 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-200 transition-colors flex items-center justify-center">
                                        <i class="fas fa-search mr-2"></i> Vérifier le vol via AviationStack
                                    </button>
                                </div>

                                <!-- Fallback Error -->
                                <div id="flight-error-msg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl text-sm border border-red-100">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                        <span>Vol introuvable dans la base globale.</span>
                                    </div>
                                    <button type="button" onclick="enableManualOverride()" class="text-red-700 font-bold underline hover:text-red-800">
                                        Saisir manuellement
                                    </button>
                                </div>

                                <!-- Override Selector -->
                                <div id="manual-type-selector" class="hidden bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                    <label class="block text-sm font-semibold text-yellow-800 mb-2">Type de Vol (Saisie Forcée)</label>
                                    <select id="manual_flight_type" class="w-full p-3 border border-yellow-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-yellow-400" onchange="updatePriceManual()">
                                        <option value="international">International (55$)</option>
                                        <option value="national">Domestique (15$)</option>
                                    </select>
                                    <button type="button" onclick="confirmManualFlight(true)" class="w-full bg-yellow-500 text-white font-bold py-2 mt-3 rounded-lg hover:bg-yellow-600">
                                        Confirmer Saisie Manuelle
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ================= PHASE 1.5: CONFIRMED FLIGHT CARD ================= -->
                        <div id="confirmed-flight-card" class="hidden bg-white border-2 border-green-500 rounded-xl p-4 shadow-sm relative overflow-hidden">
                             <div class="absolute top-0 right-0 p-2">
                                <span id="cf-price-badge" class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded">INTERNATIONAL</span>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center shrink-0">
                                    <i class="fas fa-plane"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 id="cf-airline" class="font-bold text-gray-800 text-lg">Air France</h4>
                                    <div class="flex flex-col sm:flex-row sm:items-center text-sm text-gray-500 gap-1 sm:gap-2">
                                        <span id="cf-route" class="font-bold text-gray-700">FIH ➔ CDG</span>
                                        <span class="hidden sm:inline">|</span>
                                        <span id="cf-date">2023-10-27</span>
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="resetFlightSelection()" class="absolute bottom-2 right-2 text-xs text-gray-400 hover:text-red-500 underline z-10 p-2">
                                Changer de vol
                            </button>
                        </div>


                        <!-- ================= PHASE 2: PASSENGERS ================= -->
                        <div id="phase-passengers" class="hidden space-y-6">

                            <!-- Passenger List -->
                            <div id="passenger-list" class="space-y-4">
                                <!-- Dynamic Rows -->
                            </div>

                            <!-- Add Button -->
                            <div class="flex justify-end">
                                <button type="button" onclick="addPassengerRow()" class="text-blue-600 font-bold hover:text-blue-800 flex items-center bg-blue-50 px-4 py-2 rounded-lg transition-colors border border-blue-100">
                                    <i class="fas fa-plus-circle mr-2"></i> Ajouter un autre passager
                                </button>
                            </div>

                        </div>
                    </form>
                </div>

                <!-- Composant C : Footer Validation -->
                <div class="p-6 bg-gray-50 border-t border-gray-200 z-10">
                    <div class="max-w-3xl mx-auto flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Montant à percevoir (<span id="count-passengers">0</span> passagers)</p>
                            <p class="text-3xl font-bold text-gray-800" id="display-amount">0.00 $</p>
                        </div>
                        <button type="button" onclick="submitSale()" id="submitBtn" class="bg-gray-300 text-gray-500 cursor-not-allowed font-bold py-4 px-10 rounded-2xl shadow-none flex items-center text-lg transition-all" disabled>
                            <i class="fas fa-print mr-3"></i>
                            <span>ENCAISSER & IMPRIMER</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. DROITE : HISTORIQUE (30%) - Mobile Drawer -->
        <div id="history-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity" onclick="toggleHistory()"></div>

        <section id="history-section" class="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 lg:relative lg:translate-x-0 lg:w-[30%] lg:shadow-none lg:z-auto lg:inset-auto flex flex-col lg:h-full flex-shrink-0 mt-0 lg:mt-0">
            <div class="bg-white rounded-none lg:rounded-2xl shadow-none lg:shadow-lg flex flex-col h-full lg:h-full overflow-hidden border-l lg:border border-gray-100">
                <div class="p-5 border-b border-gray-100 bg-gray-50/80 backdrop-blur flex justify-between items-center">
                    <h3 class="font-bold text-gray-800 flex items-center">
                        <i class="fas fa-history mr-2 text-blue-500"></i> Ventes Récentes
                    </h3>
                    <button onclick="toggleHistory()" class="lg:hidden text-gray-500 hover:text-gray-800">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-gray-50/30">
                    <!-- Empty State -->
                    <div id="empty-state" class="flex flex-col items-center justify-center h-48 text-gray-400">
                        <i class="fas fa-receipt text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">Aucune vente cette session</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Hidden iframe container for printing loop -->
    <div id="print-container" style="display:none;"></div>

    <script src="{{ url_for('static', filename='js/ops/pos.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const config = {
                verifyFlightUrl: "{{ url_for('api.verify_flight') }}",
                posSaleUrl: "{{ url_for('ops.pos_sale') }}",
                csrfToken: "{{ csrf_token() }}"
            };
            initPOS(config);
        });
    </script>
</body>
</html>
