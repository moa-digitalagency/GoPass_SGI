<!--
* Nom de l'application : GoPass SGI-GP
 * Description : Logic and implementation for index.html
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
-->

{% extends "base.html" %}

{% block title %}Rapports - GO-PASS{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-chart-line mr-3"></i>Rapports & BI
        </h1>
        <div class="text-sm text-gray-500">
            Dernière mise à jour: {{ now }}
        </div>
    </div>

    <!-- Row 1: Audit Anti-Coulage -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">
            <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Audit Anti-Coulage
        </h2>
        <div class="h-80 w-full">
            <canvas id="auditChart"></canvas>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">Comparaison Passagers Manifeste (Déclarés) vs Passagers Scannés (Réels)</p>
    </div>

    <!-- Row 2: Revenue & Heatmap -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Revenue Distribution -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">
                <i class="fas fa-chart-pie mr-2 text-blue-500"></i>Répartition des Recettes
            </h2>
            <div class="h-64 w-full flex justify-center">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Flight Density Heatmap -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">
                <i class="fas fa-map-marked-alt mr-2 text-green-500"></i>Densité des Vols (24h)
            </h2>
            <div id="map" class="h-64 w-full rounded z-0"></div>
        </div>
    </div>

    <!-- Row 3: Top Anomalies -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">
            <i class="fas fa-user-shield mr-2 text-orange-500"></i>Top 10 Anomalies & Fraudes Récentes
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                    <tr>
                        <th class="py-3 px-6 text-left">Heure</th>
                        <th class="py-3 px-6 text-left">ID Billet</th>
                        <th class="py-3 px-6 text-left">Type</th>
                        <th class="py-3 px-6 text-left">Agent Contrôleur</th>
                        <th class="py-3 px-6 text-center">Statut</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light">
                    {% if anomalies %}
                        {% for log in anomalies %}
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">
                                {{ log.validation_time.strftime('%Y-%m-%d %H:%M:%S') }}
                            </td>
                            <td class="py-3 px-6 text-left">
                                {% if log.pass_record %}
                                    <span class="font-medium">{{ log.pass_record.pass_number }}</span>
                                {% else %}
                                    <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-6 text-left">
                                {% if log.pass_record and log.pass_record.pass_type %}
                                    <span class="px-2 py-1 rounded text-xs text-white" style="background-color: {{ log.pass_record.pass_type.color }}">
                                        {{ log.pass_record.pass_type.name }}
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="py-3 px-6 text-left">
                                {% if log.validator %}
                                    {{ log.validator.first_name }} {{ log.validator.last_name }}
                                {% else %}
                                    Système
                                {% endif %}
                            </td>
                            <td class="py-3 px-6 text-center">
                                {% if log.status == 'ALREADY_SCANNED' %}
                                    <span class="bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs font-bold">DÉJÀ SCANNÉ</span>
                                {% elif log.status == 'WRONG_FLIGHT' %}
                                    <span class="bg-orange-200 text-orange-600 py-1 px-3 rounded-full text-xs font-bold">MAUVAIS VOL</span>
                                {% elif log.status == 'INVALID' %}
                                    <span class="bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs font-bold">INVALIDE</span>
                                {% else %}
                                    <span class="bg-gray-200 text-gray-600 py-1 px-3 rounded-full text-xs">{{ log.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="py-4 text-center text-gray-500">Aucune anomalie récente détectée.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Data from Flask
    const auditData = {{ audit_data | tojson }};
    const revenueData = {{ revenue_data | tojson }};
    const heatmapData = {{ heatmap_data | tojson }};

    // 1. Audit Chart (Grouped Bar)
    const ctxAudit = document.getElementById('auditChart').getContext('2d');

    const auditLabels = auditData.map(d => d.flight_number);
    const manifestCounts = auditData.map(d => d.manifest);
    const scannedCounts = auditData.map(d => d.scanned);

    // Determine colors for scanned bars (Red if Scanned > Manifest)
    const scannedColors = auditData.map(d => d.alert ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)');

    new Chart(ctxAudit, {
        type: 'bar',
        data: {
            labels: auditLabels,
            datasets: [
                {
                    label: 'Manifeste (Déclarés)',
                    data: manifestCounts,
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Scannés (Réels)',
                    data: scannedCounts,
                    backgroundColor: scannedColors,
                    borderColor: scannedColors.map(c => c.replace('0.8', '1')),
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 2. Revenue Chart (Donut)
    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    const revLabels = Object.keys(revenueData);
    const revValues = Object.values(revenueData);
    const revColors = ['#10B981', '#F59E0B', '#3B82F6', '#EF4444']; // Colors for segments

    new Chart(ctxRevenue, {
        type: 'doughnut',
        data: {
            labels: revLabels,
            datasets: [{
                data: revValues,
                backgroundColor: revColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // 3. Heatmap (Map)
    // Initialize map centered on DRC
    const map = L.map('map').setView([-2.9, 23.8], 5); // Approximate center of DRC

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Add circles for heatmap data
    heatmapData.forEach(point => {
        // Radius based on count (scaled)
        const radius = Math.max(point.count * 20000, 50000);

        L.circle([point.lat, point.lng], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: radius
        }).addTo(map)
        .bindPopup(`<b>${point.name}</b><br>Billets émis (24h): ${point.count}`);
    });

    // Workaround for map rendering issues in tabs/hidden divs (resize)
    setTimeout(() => { map.invalidateSize(); }, 100);

</script>
{% endblock %}
